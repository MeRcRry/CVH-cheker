<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—è–≤–æ–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    #form {
      text-align: center;
      margin-bottom: 20px;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .entry-pair {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 30px;
      width: 100%;
      justify-content: center;
    }
    .box {
      flex: 1 1 300px;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .box h3 {
      margin-top: 0;
    }
    a {
      word-break: break-word;
    }
  </style>
</head>
<body>
  <h1>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–∏—Ö –∑–∞—è–≤–æ–∫</h1>

  <div id="form">
    <input type="email" id="email" placeholder="–í–≤–µ–¥–∏—Ç–µ email">
    <button onclick="checkStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
  </div>

  <div id="allResults"></div>

  <script>
    function formatDate(input) {
      if (!input) return "‚Äî";
      const date = new Date(input);
    
      // –°–¥–≤–∏–≥ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ -1 —á–∞—Å (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
      date.setHours(date.getHours() - 1);
    
      return isNaN(date) ? input : date.toLocaleDateString("ru-RU", {
        day: "numeric",
        month: "long",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });
    }


    function getFileLink(link) {
      if (!link || link === "-" || link.length < 10) {
        return `<i style="color:gray">–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</i>`;
      }
      if (link.includes("drive.google.com")) {
        const match = link.match(/[-\w]{25,}/);
        if (match) {
          const fileId = match[0];
          const directUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
          return `<a href="${directUrl}" target="_blank">üì• –°–∫–∞—á–∞—Ç—å</a>`;
        } else {
          return `<a href="${link}" target="_blank">üìÇ –û—Ç–∫—Ä—ã—Ç—å</a>`;
        }
      }
      if (!link.includes("http")) {
        return `<i style="color:gray">–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ —Å—Å—ã–ª–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</i>`;
      }
      return `<a href="${link}" target="_blank">üìÇ –û—Ç–∫—Ä—ã—Ç—å</a>`;
    }

    async function checkStatus() {


      const email = document.getElementById("email").value.trim().toLowerCase();
      const url = `https://script.google.com/macros/s/AKfycbx5V9YBKypfzwoq7wxf8_2_Y9CwJbAAiU2wplWVVtiHb-JPzS1OILvXgGbj8BMdLybulA/exec?email=${encodeURIComponent(email)}`;
      const container = document.getElementById("allResults");
      container.innerHTML = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";

      try {
        const res = await fetch(url);
        const data = await res.json();

        const entries = data.results.filter(e =>
          (e["–ê–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã"] || "").trim().toLowerCase() === email
        );


        if (!data || !Array.isArray(data.results) || data.results.length === 0) {
          userData.innerHTML = "<h3>üìå –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3><p><b>–î–∞–Ω–Ω—ã—Ö –ø–æ –≤–≤–µ–¥—ë–Ω–Ω–æ–º—É email –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</b></p>";
          checkData.innerHTML = "<h3>‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞</h3><p>‚Äî</p>";
          resultBox.style.display = "flex";
          return;
        }


        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
        entries.sort((a, b) =>
          new Date(b["–û—Ç–º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏"]) - new Date(a["–û—Ç–º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏"])
        );

        container.innerHTML = "";
        for (const entry of entries) {
          const pair = document.createElement("div");
          pair.className = "entry-pair";

          const userBox = document.createElement("div");
          userBox.className = "box";
          userBox.innerHTML = `
            <h3>üìå –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
            <b>üìÖ –û—Ç–º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:</b> ${formatDate(entry["–û—Ç–º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏"])}<br>
            <b>üìç –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</b> ${entry["–£–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ"] || "-"}<br>
            <b>üìÜ –î–∞—Ç—ã:</b> ${formatDate(entry["–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω—ã–µ –¥–∞—Ç—ã, –æ—Ç "])} ‚Äî ${formatDate(entry["–î–æ"])}<br>
            <hr>
            <b>üöú –¢–µ—Ö–Ω–∏–∫–∞:</b> ${entry["–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Ö–Ω–∏–∫–∏"] || "-"}<br>
            <b>üìé –î–æ–∫—É–º–µ–Ω—Ç:</b><br>${getFileLink(entry["–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö"])}<br>
            <b>üè¢ –ê–¥—Ä–µ—Å –°–í–•:</b> ${entry["–ê–¥—Ä–µ—Å –°–í–•"] || "-"}<br>
            <b>üè¢ –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞:</b> ${entry["–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞"] || "-"}<br>
            <b>üè¢ –¢–æ–≤–∞—Ä:</b> ${entry["–¢–æ–≤–∞—Ä"] || "-"}<br>
            <b>üè¢ –ü—Ä–æ—Ñ–∏–ª—å —Ä–∏—Å–∫–∞:</b> ${entry["–ü—Ä–æ—Ñ–∏–ª—å —Ä–∏—Å–∫–∞"] || "-"}<br>
            <b>üè¢ –£–∫–∞–∑–∞–Ω–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b> ${entry["–£–∫–∞–∂–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é"] || "–û—Ç—Å—É—Ç—Å–≤—É–µ—Ç"}<br>
          `;

          const status = (entry["–°—Ç–∞—Ç—É—Å"] || "-").toLowerCase();
          let statusColor = "#ccc";
          if (status.includes("–æ—Ç–∫–ª")) statusColor = "#f8d7da";
          else if (status.includes("–¥–µ–π—Å—Ç–≤") || status.includes("–æ–¥–æ–±—Ä")) statusColor = "#d4edda";
          else if (status.includes("–æ–∂–∏–¥")) statusColor = "#d1ecf1";

          const checkBox = document.createElement("div");
          checkBox.className = "box";
          checkBox.innerHTML = `
            <div style="background-color: ${statusColor}; padding: 15px; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1);">
              <h3>‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞</h3>
              <b>–°—Ç–∞—Ç—É—Å:</b> <span style="font-weight:bold;">${entry["–°—Ç–∞—Ç—É—Å"] || "–í –æ–∂–∏–¥–∞–Ω–∏–∏"}</span><br>
              <b>üìÖ –î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:</b> ${formatDate(entry["–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏"])}<br>
              <b>üìÅ –ö–æ–Ω–µ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç:</b><br>${getFileLink(entry["–ö–æ–Ω–µ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç"])}
            </div>
          `;

          pair.appendChild(userBox);
          pair.appendChild(checkBox);
          container.appendChild(pair);
        }
      } catch (e) {
        container.innerHTML = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.";
        console.error(e);
      }
    }
  </script>
</body>
</html>
